<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FootballTix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f8fafc; }
        .admin-badge { background: #f59e42; color: #fff; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; font-size: 0.9rem; }
        .table th, .table td { padding: 0.75rem 1rem; }
        .table th { background: #f3f4f6; }
        .table tr:nth-child(even) { background: #f9fafb; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-blue-700" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-3.5l6-4.5-6-4.5v9z"></path>
                    </svg>
                    <span class="ml-2 text-xl font-bold text-gray-900">FootballTix</span>
                    <span class="ml-4 admin-badge">Admin</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-500 hover:text-blue-700">Home</a>
                    <a href="leagues.html" class="text-gray-500 hover:text-blue-700">Leagues</a>
                    <a href="events.html" class="text-gray-500 hover:text-blue-700">Events</a>
                    <a href="bookings.html" class="text-gray-500 hover:text-blue-700">Bookings</a>
                    <a href="#" onclick="handleLogout()" class="text-red-600 hover:text-red-800 font-semibold">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <h1 class="text-3xl font-bold mb-8">Admin Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Leagues Management -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-xl font-bold mb-4">Leagues Management</h2>
                <!-- Add Event Form -->
                <form id="add-event-form" class="mb-8 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="event-title" class="w-full border rounded p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
                            <input type="text" id="event-venue" class="w-full border rounded p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                            <input type="datetime-local" id="event-date" class="w-full border rounded p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Seats</label>
                            <input type="number" id="event-seats" class="w-full border rounded p-2" min="1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                            <input type="number" id="event-price" class="w-full border rounded p-2" min="0" step="0.01" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">League</label>
                            <select id="event-league" class="w-full border rounded p-2" required>
                                <option value="">Select League</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="event-description" class="w-full border rounded p-2" rows="2" required></textarea>
                    </div>
                    <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded font-semibold hover:bg-blue-800">Add Match</button>
                    <div id="add-event-message" class="mt-2 text-sm"></div>
                </form>
                <!-- End Add Event Form -->
                <!-- Events Management Table -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">All Matches</h3>
                    <div class="overflow-x-auto">
                        <table id="admin-events-table" class="table min-w-full border rounded-lg">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Venue</th>
                                    <th>League</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-events-tbody">
                                <tr><td colspan="6">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- End Events Management Table -->
                <div class="overflow-x-auto">
                    <table id="admin-leagues-table" class="table min-w-full border rounded-lg">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Status</th>
                                <th>Founded</th>
                                <th>Teams</th>
                            </tr>
                        </thead>
                        <tbody id="admin-leagues-tbody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Placeholder for future admin features -->
            <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col items-center justify-center">
                <h2 class="text-xl font-bold mb-4">Welcome, Admin!</h2>
                <p class="text-gray-600 mb-4">Use the dashboard to manage leagues, events, and monitor system activity.</p>
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-12 h-12 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 014-4h2a4 4 0 014 4v2M9 17H7a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4h-2M9 17v2a2 2 0 002 2h2a2 2 0 002-2v-2"></path>
                    </svg>
                </div>
                <span class="text-blue-700 font-semibold">More features coming soon...</span>
            </div>
        </div>
    </div>
    <script src="js/bookings.js"></script>
    <script>
    function handleLogout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        window.location.href = 'index.html';
    }

    // Add event form logic
    const addEventForm = document.getElementById('add-event-form');
    const leagueSelect = document.getElementById('event-league');
    const addEventMessage = document.getElementById('add-event-message');

    // Populate league dropdown
    fetch('/api/leagues')
        .then(res => res.json())
        .then(leagues => {
            if (Array.isArray(leagues)) {
                leagues.forEach(l => {
                    const opt = document.createElement('option');
                    opt.value = l.id;
                    opt.textContent = l.name;
                    leagueSelect.appendChild(opt);
                });
            }
        });

    addEventForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        addEventMessage.textContent = '';
        const title = document.getElementById('event-title').value.trim();
        const description = document.getElementById('event-description').value.trim();
        const venue = document.getElementById('event-venue').value.trim();
        const eventDate = document.getElementById('event-date').value;
        const totalSeats = parseInt(document.getElementById('event-seats').value, 10);
        const price = parseFloat(document.getElementById('event-price').value);
        const leagueId = leagueSelect.value;
        if (!title || !description || !venue || !eventDate || !totalSeats || !price || !leagueId) {
            addEventMessage.textContent = 'Please fill all fields.';
            addEventMessage.className = 'text-red-600 mt-2';
            return;
        }
        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify({
                    title,
                    description,
                    venue,
                    eventDate,
                    totalSeats,
                    price,
                    leagueId
                })
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(err);
            }
            addEventMessage.textContent = 'Match added successfully!';
            addEventMessage.className = 'text-green-600 mt-2';
            addEventForm.reset();
            setTimeout(loadAdminEvents, 1000); // Reload events after adding
        } catch (err) {
            addEventMessage.textContent = 'Failed to add match: ' + err.message;
            addEventMessage.className = 'text-red-600 mt-2';
        }
    });

    // --- EVENTS CRUD LOGIC ---
    const eventsTableBody = document.getElementById('admin-events-tbody');
    let leaguesMap = {};

    function formatEventDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    async function loadAdminEvents() {
        eventsTableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
            const res = await fetch('/api/events');
            if (!res.ok) throw new Error('Failed to fetch events');
            const events = await res.json();
            if (!Array.isArray(events) || events.length === 0) {
                eventsTableBody.innerHTML = '<tr><td colspan="6">No matches found.</td></tr>';
                return;
            }
            // Fetch leagues for mapping
            const leaguesRes = await fetch('/api/leagues');
            const leagues = await leaguesRes.json();
            leaguesMap = {};
            leagues.forEach(l => leaguesMap[l.id] = l.name);
            eventsTableBody.innerHTML = events.map(ev => `
                <tr>
                    <td>${ev.title}</td>
                    <td>${formatEventDateTime(ev.eventDate)}</td>
                    <td>${ev.venue}</td>
                    <td>${leaguesMap[ev.leagueId] || '-'}</td>
                    <td>£${ev.price}</td>
                    <td>
                        <button onclick="showEditEventModal(${ev.id})" class="text-blue-600 hover:underline mr-2">Edit</button>
                        <button onclick="deleteEvent(${ev.id})" class="text-red-600 hover:underline">Delete</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            eventsTableBody.innerHTML = `<tr><td colspan="6">Error: ${err.message}</td></tr>`;
        }
    }

    // Call after adding event and on page load
    addEventForm.addEventListener('submit', function() { setTimeout(loadAdminEvents, 1000); });
    document.addEventListener('DOMContentLoaded', loadAdminEvents);

    // Delete event
    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this match?')) return;
        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch(`/api/events/${eventId}`, {
                method: 'DELETE',
                headers: { 'Authorization': token ? `Bearer ${token}` : '' }
            });
            if (!res.ok) throw new Error(await res.text());
            loadAdminEvents();
            showSuccess('Match deleted successfully!');
        } catch (err) {
            showError('Failed to delete match: ' + err.message);
        }
    }

    // Edit event modal
    function showEditEventModal(eventId) {
        fetch(`/api/events/${eventId}`)
            .then(res => res.json())
            .then(ev => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-lg w-full relative">
                        <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">&times;</button>
                        <h3 class="text-xl font-bold mb-4">Edit Match</h3>
                        <form id="edit-event-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input type="text" id="edit-title" class="w-full border rounded p-2" value="${ev.title}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
                                    <input type="text" id="edit-venue" class="w-full border rounded p-2" value="${ev.venue}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                                    <input type="datetime-local" id="edit-date" class="w-full border rounded p-2" value="${ev.eventDate ? ev.eventDate.substring(0,16) : ''}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Total Seats</label>
                                    <input type="number" id="edit-seats" class="w-full border rounded p-2" min="1" value="${ev.totalSeats}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                                    <input type="number" id="edit-price" class="w-full border rounded p-2" min="0" step="0.01" value="${ev.price}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">League</label>
                                    <select id="edit-league" class="w-full border rounded p-2" required></select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="edit-description" class="w-full border rounded p-2" rows="2" required>${ev.description}</textarea>
                            </div>
                            <button type="submit" class="mt-4 bg-blue-700 text-white px-6 py-2 rounded font-semibold hover:bg-blue-800">Save Changes</button>
                            <div id="edit-event-message" class="mt-2 text-sm"></div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                // Populate league dropdown
                fetch('/api/leagues').then(res => res.json()).then(leagues => {
                    const select = modal.querySelector('#edit-league');
                    leagues.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        if (l.id === ev.leagueId) opt.selected = true;
                        select.appendChild(opt);
                    });
                });
                // Handle submit
                modal.querySelector('#edit-event-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const message = modal.querySelector('#edit-event-message');
                    message.textContent = '';
                    const title = modal.querySelector('#edit-title').value.trim();
                    const description = modal.querySelector('#edit-description').value.trim();
                    const venue = modal.querySelector('#edit-venue').value.trim();
                    const eventDate = modal.querySelector('#edit-date').value;
                    const totalSeats = parseInt(modal.querySelector('#edit-seats').value, 10);
                    const price = parseFloat(modal.querySelector('#edit-price').value);
                    const leagueId = modal.querySelector('#edit-league').value;
                    if (!title || !description || !venue || !eventDate || !totalSeats || !price || !leagueId) {
                        message.textContent = 'Please fill all fields.';
                        message.className = 'text-red-600 mt-2';
                        return;
                    }
                    const token = localStorage.getItem('accessToken');
                    try {
                        const res = await fetch(`/api/events/${eventId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify({
                                title,
                                description,
                                venue,
                                eventDate,
                                totalSeats,
                                price,
                                leagueId
                            })
                        });
                        if (!res.ok) {
                            const err = await res.text();
                            throw new Error(err);
                        }
                        message.textContent = 'Match updated successfully!';
                        message.className = 'text-green-600 mt-2';
                        setTimeout(() => {
                            modal.remove();
                            loadAdminEvents();
                        }, 1000);
                    } catch (err) {
                        message.textContent = 'Failed to update match: ' + err.message;
                        message.className = 'text-red-600 mt-2';
                    }
                });
            });
    }
    </script>
</body>
</html> 